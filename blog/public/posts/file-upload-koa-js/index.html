<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Simple file upload using Koa.js (or Node.js in General) | Velan Salis</title>
<meta name="keywords" content="koajs, nodejs" />
<meta name="description" content="A post about how to use Koa.js to upload files">
<meta name="author" content="Velan Salis">
<link rel="canonical" href="https://0xv31an5a1i5.xyz/posts/file-upload-koa-js/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.758964cca2408a587580fa496552b76d649fb5d8d1957d8497b09d5bc58c4dfe.css" integrity="sha256-dYlkzKJAilh1gPpJZVK3bWSftdjRlX2El7CdW8WMTf4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://0xv31an5a1i5.xyz/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://0xv31an5a1i5.xyz/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://0xv31an5a1i5.xyz/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://0xv31an5a1i5.xyz/apple-touch-icon.png">
<link rel="mask-icon" href="https://0xv31an5a1i5.xyz/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.92.0" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Simple file upload using Koa.js (or Node.js in General)" />
<meta property="og:description" content="A post about how to use Koa.js to upload files" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://0xv31an5a1i5.xyz/posts/file-upload-koa-js/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-01-20T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2018-01-20T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Simple file upload using Koa.js (or Node.js in General)"/>
<meta name="twitter:description" content="A post about how to use Koa.js to upload files"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://0xv31an5a1i5.xyz/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Simple file upload using Koa.js (or Node.js in General)",
      "item": "https://0xv31an5a1i5.xyz/posts/file-upload-koa-js/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Simple file upload using Koa.js (or Node.js in General)",
  "name": "Simple file upload using Koa.js (or Node.js in General)",
  "description": "A post about how to use Koa.js to upload files",
  "keywords": [
    "koajs", "nodejs"
  ],
  "articleBody": "I have been using Koa.js for a while now and it turns out to be great. Iâ€™m having a lot of fun playing around with it since its simple and configurable. And I was searching for a ground up way to execute file uploads so that I can tweak its functionality however I want to. And it turns out, Itâ€™s not as difficult as I thought. Before going forward, Iâ€™m assuming you have a basic knowledge of how to setup basic Koa.js server with routers since itâ€™s being covered in so many articles. So Iâ€™ll be skipping the server setup with routers. Click here if you want to go through an article that covers the same. So, Lets get coding. ðŸ˜‰\nServer Page : app.js // app.js const Koa = require(\"koa\"); const koaBody = require(\"koa-body\"); const logger = require(\"koa-logger\"); const router = require(\"./router\"); const app = new Koa(); app.use(koaBody( { multipart: true } )); app.use(logger()); app.use(router.routes()).use(router.allowedMethods()); app.listen(3000, () = { console.log(\"Listening at 3000\"); }); The above app.js file starts up the server and starts listening in port 3000 for requests. Simple stuff, nothing fancy. But things to be noted are the koa-body module and { multipart : true } option. This part is really important, since koa-body parses the request body and populates Koa ctx object based on the form data being sent. When a file is being sent from the front-end, koa-body parses the request and the uploaded file attributes will be available under ctx.request.files which we can then access across Koa server to implement file upload functionality\nRouter and Upload Logic : Router.js Well, Its not a good practice to add the server logic under router.js file since router is only used for routing the requests. You will have a controller file to take care of the logic when the request is being routed from router. But for the course of this tutorial, I have written the logic in the router itself.\nIn this part, you will need a package called promisepipe which Iâ€™ll explain in a second. For now, install the package by running the following command. And create a folder named uploads in the root of the project which will hold uploaded images.\nnpm install promisepipe // router.js const Koa = require(\"koa\"); const Router = require(\"koa-router\"); const promisePipe = require(\"promisepipe\"); const fs = require(\"fs\"); const path = require(\"path\"); const router = new Router(); router.get(\"/\", (context, next) = { context.body = \"Hey\"; }); router.post(\"/upload\", async (context, next) { try { const uploadfile = context.request.files.file; const savefile = `${Date.now()}#${uploadfile.name}`; const readStream = fs.createReadStream(uploadfile.path); const writeStream = fs.createWriteStream(path.join(\"uploads\", savefile)); await promisePipe( readStream.on(\"error\", () = { throw new Error({ errors: \"File Read Error\" }); }), writeStream.on(\"error\", () = { throw new Error({ errors: \"Write Error\" }); }) ); context.body = { message: \"File Uploaded\" }; } catch (err) { console.log(err); context.body = { message: \"There was an error\", errors: err }; } }); module.exports = router; The Upload Logic Anything that is written in the bold letters in router.js is important and Iâ€™ll be explaining the mode of execution one by one.\n  /upload : This is the POST route handler that contains the logic of what needs to be done when the front-end makes an upload request with a file attached to its body. When the URL is hit, the function gets executed.\n  uploadfile : File attributes from parsed context.request.files.file in uploadfile stored in this variable so that its easier to access it later on in the code. In simple words, uploadfile contains the reference to the file to be uploaded to the server.\n  savefile : The file name to be stored in the folder has to be unique since the same name will be stored in the database to trace down the files from the folder later. So we use {Date.now()}#${uploadfile.nameto create unique name (where uploadfile.name is the name of the file to be uploaded). Which will give us a string of 1560234246152#anyfile.txt for example. Since we add the timstamp, filename stays unique and it will be stored in savefile variable.\n  readStream/writestream : Stream is nothing but a flow of bits from one end to another end. In here, we create a read stream from userâ€™s local computer and write stream to serverâ€™s uploads directory. We pass uploadfile.path which contains userâ€™s local fileâ€™s path and uploads folder to write stream. That sets up the stream needed for the upload.\n  promisePipe : promisePipe is a package that takes in two streams ( read / write ) and starts reading from read file to the write file. In here, bits from the userâ€™s local computer file will be written in streams to the uploads directory on the server with the name mentioned in the variable savefile . The best thing about promisepipe is it returns a promise. It returns a resolved response when the uploading is done or returns the rejected response when there is an error. So we can await untill the uploading is done and continue executing code thereafter, or we can use try/catch block to catch any errors while uploading and handle it.\n  By the end of execution, file will be saved in uploads folder and its name will be stored in savefile variable which can be added to the database for tracking down the files when they are requested. And if there is an error while reading or writing, it will be caught by the catch block and valid response to the front-end will be sent.\nSumming it all up Koa.js is an amazing lightweight configurable framework for Node.js. And arguably, There could be tons of better ways to achieve the same results but this turned out to be the best one for me where i can configure the functionality from the ground up. So if you know of any way to make this code better with added functionalities, Iâ€™d look forward to hear it from you. Happy coding. Have a nice day ðŸ˜„\nImportant Links   Koa.js : Koa is a new web framework designed by the team behind Express, which aims to be a smaller, more expressive, and more. https://koajs.com/\n  koa-body : A Koa body parser middleware. Supports multipart, urlencoded and JSON request bodies. https://www.npmjs.com/package/koa-body\n  promisepipe : Pipe node.js streams safely with Promises. https://www.npmjs.com/package/promisepipe\n  ",
  "wordCount" : "1038",
  "inLanguage": "en",
  "datePublished": "2018-01-20T00:00:00Z",
  "dateModified": "2018-01-20T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Velan Salis"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://0xv31an5a1i5.xyz/posts/file-upload-koa-js/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Velan Salis",
    "logo": {
      "@type": "ImageObject",
      "url": "https://0xv31an5a1i5.xyz/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://0xv31an5a1i5.xyz/" accesskey="h" title="Velan Salis (Alt + H)">Velan Salis</a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://0xv31an5a1i5.xyz/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://0xv31an5a1i5.xyz/archive" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://0xv31an5a1i5.xyz/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Simple file upload using Koa.js (or Node.js in General)
    </h1>
    <div class="post-description">
      A post about how to use Koa.js to upload files
    </div>
    <div class="post-meta"><span title='2018-01-20 00:00:00 +0000 UTC'>January 20, 2018</span>&nbsp;Â·&nbsp;5 min&nbsp;Â·&nbsp;Velan Salis

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#server-page--appjs" aria-label="Server Page : app.js">Server Page : app.js</a></li>
                <li>
                    <a href="#router-and-upload-logic--routerjs" aria-label="Router and Upload Logic : Router.js">Router and Upload Logic : Router.js</a></li>
                <li>
                    <a href="#the-upload-logic" aria-label="The Upload Logic">The Upload Logic</a></li>
                <li>
                    <a href="#summing-it-all-up" aria-label="Summing it all up">Summing it all up</a></li>
                <li>
                    <a href="#important-links" aria-label="Important Links">Important Links</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>I have been using Koa.js for a while now and it turns out to be great. Iâ€™m having a lot of fun playing around with it since its simple and configurable. And I was searching for a <em>ground up</em> way to execute file uploads so that I can tweak its functionality however I want to. And it turns out, Itâ€™s not as difficult as I thought. Before going forward, Iâ€™m assuming you have a basic knowledge of how to setup basic Koa.js server with routers since itâ€™s being covered in so many articles. So Iâ€™ll be skipping the server setup with routers. <a href="https://medium.com/@adam_bickford/creating-a-basic-site-with-koa-pt-1-f3e1711f7a9">Click here</a> if you want to go through an article that covers the same. So, Lets get coding. ðŸ˜‰</p>
<h3 id="server-page--appjs">Server Page : app.js<a hidden class="anchor" aria-hidden="true" href="#server-page--appjs">#</a></h3>
<pre tabindex="0"><code>// app.js
const Koa = require(&quot;koa&quot;);
const koaBody = require(&quot;koa-body&quot;);
const logger = require(&quot;koa-logger&quot;);

const router = require(&quot;./router&quot;);

const app = new Koa();

app.use(koaBody(
    { multipart: true }
));

app.use(logger());

app.use(router.routes()).use(router.allowedMethods());

app.listen(3000, () =&gt; {
    console.log(&quot;Listening at 3000&quot;);
});
</code></pre><p>The above app.js file starts up the server and starts listening in port 3000 for requests. Simple stuff, nothing fancy. But things to be noted are the koa-body module and <code>{ multipart : true }</code> option. This part is really important, since koa-body parses the request body and populates Koa <code>ctx</code> object based on the form data being sent. When a file is being sent from the front-end, koa-body parses the request and the uploaded file attributes will be available under <code>ctx.request.files</code> which we can then access across Koa server to implement file upload functionality</p>
<h3 id="router-and-upload-logic--routerjs">Router and Upload Logic : Router.js<a hidden class="anchor" aria-hidden="true" href="#router-and-upload-logic--routerjs">#</a></h3>
<p><em>Well, Its not a good practice to add the server logic under router.js file since router is only used for routing the requests. You will have a controller file to take care of the logic when the request is being routed from router. But for the course of this tutorial, I have written the logic in the router itself.</em></p>
<p>In this part, you will need a package called promisepipe which Iâ€™ll explain in a second. For now, install the package by running the following command. And create a folder named uploads in the root of the project which will hold uploaded images.</p>
<pre tabindex="0"><code>npm install promisepipe
</code></pre><pre tabindex="0"><code>// router.js
const Koa = require(&quot;koa&quot;);
const Router = require(&quot;koa-router&quot;);
const promisePipe = require(&quot;promisepipe&quot;);
const fs = require(&quot;fs&quot;);
const path = require(&quot;path&quot;);

const router = new Router();

router.get(&quot;/&quot;, (context, next) =&gt; {
    context.body = &quot;Hey&quot;;
});

router.post(&quot;/upload&quot;, async (context, next) {
    try {
        const uploadfile = context.request.files.file;
        const savefile = `${Date.now()}#${uploadfile.name}`;
        const readStream = fs.createReadStream(uploadfile.path);
        const writeStream = fs.createWriteStream(path.join(&quot;uploads&quot;, savefile));
        await promisePipe(
            readStream.on(&quot;error&quot;, () =&gt; {
                throw new Error({
                    errors: &quot;File Read Error&quot;
                });
            }),
            writeStream.on(&quot;error&quot;, () =&gt; {
                throw new Error({
                    errors: &quot;Write Error&quot;
                });
            })
        );
        context.body = {
            message: &quot;File Uploaded&quot;
        };
    } catch (err) {
        console.log(err);
        context.body = {
            message: &quot;There was an error&quot;,
            errors: err
        };
    }
});

module.exports = router;
</code></pre><h3 id="the-upload-logic">The Upload Logic<a hidden class="anchor" aria-hidden="true" href="#the-upload-logic">#</a></h3>
<p>Anything that is written in the bold letters in router.js is important and Iâ€™ll be explaining the mode of execution one by one.</p>
<ul>
<li>
<p><strong>/upload :</strong> This is the POST route handler that contains the logic of what needs to be done when the front-end makes an upload request with a file attached to its body. When the URL is hit, the function gets executed.</p>
</li>
<li>
<p><strong>uploadfile</strong> : File attributes from parsed context.request.files.file in uploadfile stored in this variable so that its easier to access it later on in the code. In simple words, uploadfile contains the reference to the file to be uploaded to the server.</p>
</li>
<li>
<p><strong>savefile</strong> : The file name to be stored in the folder has to be unique since the same name will be stored in the database to trace down the files from the folder later. So we use <code>{Date.now()}#${uploadfile.name</code>to create unique name <em>(where <em>uploadfile.name</em> is the name of the file to be uploaded)</em>. Which will give us a string of 1560234246152#anyfile.txt for example. Since we add the timstamp, filename stays unique and it will be stored in savefile variable.</p>
</li>
<li>
<p><strong>readStream/writestream</strong> : Stream is nothing but a flow of bits from one end to another end. In here, we create a read stream from userâ€™s local computer and write stream to serverâ€™s uploads directory. We pass uploadfile.path which contains userâ€™s local fileâ€™s path and uploads folder to write stream. That sets up the stream needed for the upload.</p>
</li>
<li>
<p><strong>promisePipe</strong> : promisePipe is a package that takes in two streams ( read / write ) and starts reading from read file to the write file. In here, bits from the userâ€™s local computer file will be written in streams to the uploads directory on the server with the name mentioned in the variable savefile . The best thing about promisepipe is it returns a promise. It returns a resolved response when the uploading is done or returns the rejected response when there is an error. So we can await untill the uploading is done and continue executing code thereafter, or we can use try/catch block to catch any errors while uploading and handle it.</p>
</li>
</ul>
<p>By the end of execution, file will be saved in uploads folder and its name will be stored in savefile variable which can be added to the database for tracking down the files when they are requested. And if there is an error while reading or writing, it will be caught by the catch block and valid response to the front-end will be sent.</p>
<h3 id="summing-it-all-up">Summing it all up<a hidden class="anchor" aria-hidden="true" href="#summing-it-all-up">#</a></h3>
<p>Koa.js is an amazing lightweight configurable framework for Node.js. And arguably, There could be tons of better ways to achieve the same results but this turned out to be the best one for me where i can configure the functionality from the ground up. So if you know of any way to make this code better with added functionalities, Iâ€™d look forward to hear it from you. Happy coding. Have a nice day ðŸ˜„</p>
<h3 id="important-links">Important Links<a hidden class="anchor" aria-hidden="true" href="#important-links">#</a></h3>
<ul>
<li>
<p><strong>Koa.js</strong> :
Koa is a new web framework designed by the team behind Express, which aims to be a smaller, more expressive, and more. <a href="https://koajs.com/">https://koajs.com/</a></p>
</li>
<li>
<p><strong>koa-body</strong> :
A Koa body parser middleware. Supports multipart, urlencoded and JSON request bodies. <a href="https://www.npmjs.com/package/koa-body">https://www.npmjs.com/package/koa-body</a></p>
</li>
<li>
<p><strong>promisepipe</strong> :
Pipe node.js streams safely with Promises. <a href="https://www.npmjs.com/package/promisepipe">https://www.npmjs.com/package/promisepipe</a></p>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://0xv31an5a1i5.xyz/tags/koajs/">koajs</a></li>
      <li><a href="https://0xv31an5a1i5.xyz/tags/nodejs/">nodejs</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://0xv31an5a1i5.xyz/">Velan Salis</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
